<!DOCTYPE html>
<head>
    <body lang="en">
        <meta http-equiv="Cache-Control" content="no-store" />


        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js" type="text/javascript"></script>

        <script type="text/javascript"
                src="https://rawgit.com/mleibman/SlickGrid/master/lib/jquery-ui-1.8.16.custom.min.js"></script>
        <script type="text/javascript" src="https://rawgit.com/mleibman/SlickGrid/master/lib/jquery.event.drag-2.2.js"></script>
        <script type="text/javascript" src="https://rawgit.com/mleibman/SlickGrid/2.1/slick.core.js"></script>
        <script type="text/javascript" src="https://rawgit.com/mleibman/SlickGrid/2.1/slick.grid.js"></script>
        <script type="text/javascript" src="https://rawgit.com/mleibman/SlickGrid/2.1/slick.editors.js"></script>


        <script src="http://underscorejs.org/underscore.js" type="text/javascript"></script>
        <script src="http://backbonejs.org/backbone.js" type="text/javascript"></script>
        <script src="https://rawgit.com/Leaflet/Leaflet/gh-pages/dist/leaflet.js" type="text/javascript"></script>
        <!--script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js" type="text/javascript"></script-->
        <script src="https://rawgit.com/janl/mustache.js/master/mustache.js"></script>
        <script src="http://okfnlabs.org/recline//dist/recline.js" type="text/javascript"></script>
        <script src="http://okfnlabs.org/ckan.js/ckan.js"></script>

        <script type="text/javascript" src="https://rawgit.com/flot/flot/master/jquery.flot.js"></script>
        <script type="text/javascript" src="https://rawgit.com/flot/flot/master/jquery.flot.time.js"></script>
        <script type="text/javascript" src="http://momentjs.com/downloads/moment.min.js"></script>
        <script type="text/javascript"
                src="https://rawgit.com/Leaflet/Leaflet.markercluster/master/dist/leaflet.markercluster.js"></script>

        <meta charset="utf-8">
        <title>CKAN web-data connector</title>
        <meta name="description" content="">
        <meta name="author" content="">

        <!-- Le HTML5 shim, for IE6-8 support of HTML elements>
        <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <link rel="stylesheet" href="vendor/recline/vendor/leaflet/0.4.4/leaflet.ie.css">
        <link rel="stylesheet" href="vendor/recline/vendor/leaflet.markercluster/MarkerCluster.Default.ie.css">
        <[endif]-->

        <link href="http://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet" type="text/css">
        <link href="http://netdna.bootstrapcdn.com/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet" />
        <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.0/css/font-awesome.css" rel="stylesheet">

        <link rel="stylesheet" href="https://rawgit.com/mleibman/SlickGrid/master/slick.grid.css">
        <link rel="stylesheet" href="https://rawgit.com/Leaflet/Leaflet/master/dist/leaflet.css">
        <link rel="stylesheet" href="https://rawgit.com/Leaflet/Leaflet.markercluster/master/dist/MarkerCluster.css">
        <link rel="stylesheet" href="https://rawgit.com/Leaflet/Leaflet.markercluster/master/dist/MarkerCluster.Default.css">
        <link rel="stylesheet" href="http://okfnlabs.org/recline//dist/recline.css">

        <link rel="stylesheet" href="ckanstyle.css" />


        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="brand" href="#">CKAN Web Data Connector</a>
                    <ul class="nav">
                        <li class="divider-vertical"></li>
                    </ul>
                    <ul class="nav pull-right">
                        <li>
                            <a class="nav-logo pull-left" href="http://ckan.org/"
                               title="Comprehensive Knowlege Archive Network">
                                <img src="http://www.edawax.de/wp-content/uploads/2013/09/250_logo-ckan.jpg" alt="CKAN logo"
                                     style="height: 30px" />
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="content">
                <div class="view home">
                    <div class="row">
                        <div class="span9">
                            <div class="intro-div">
                                <div class="form-group">
                                    <label for="ckanAPIKey">
                                        Your CKAN instance API Key may permit you to access non-public
                                        datasets you may have created.
                                    </label>
                                    <input type="text" class="form-control catchReturn" id="ckanAPIKey"
                                           placeholder="Enter your CKAN API key...">
                                </div>
                                <h2>Welcome</h2>

                                <p>
                                    This application is a modified version of <a href="http://dev.rufuspollock.org/ckan-explorer/">CKAN Data Explorer</a>
                                    and let's you explore, analyze and visualize data stored in a CKAN DataStore and the pass
                                    that data to Tableau for further analysis.
                                </p>

                                <h3>Get Started</h3>

                                <p>
                                    CKAN is used to host many government data sites. If not <a href="https://github.com/ckan/ckan/issues/1944">CORS-disabled</a>,
                                    use this tool to access the data. By changing '?endpoint=http://your.ckan-server.url', the
                                    sidebar reflects available data in that server.
                                    Datasets (in bold) contain Resources (which may originally have been CSV, XLS or other
                                    file-types).
                                    If the Resource has been written to the DataStore (postgres database), then they will
                                    display
                                    as links where the data is accessible via the DataStore API. Resources not available via
                                    the DataStore will have 'strikethrough' formatting and are not available for ingesting to
                                    Tableau. To get started
                                    click on one of the available Resource links on the right. You might have to Search for
                                    relevant ones first.
                                </p>

                                <p>
                                    Each Resource has its own table in the DataStore. On the backend, Tables are named using
                                    UUIDs but can also have alias View names. It is also possible to JOIN two or more tables
                                    using a common field ahead of pushing the data to Tableau. (e.g)
                                </p>
                                <span style="font-size:0.8em">SELECT "2f146bfa-7515-4d25-936a-5a7e6b83ea20"."ID" AS "ID", "34b16ea9-36f5-4f2d-84db-3b344372bf08"."CODE_DES" AS "CODE_DES" FROM "2f146bfa-7515-4d25-936a-5a7e6b83ea20" INNER JOIN "34b16ea9-36f5-4f2d-84db-3b344372bf08" ON ("2f146bfa-7515-4d25-936a-5a7e6b83ea20"."FREQ" = "34b16ea9-36f5-4f2d-84db-3b344372bf08"."CODE_ID");</span>
                                </p>
                            </div>
                            <div class="data-views-container"></div>
                        </div>
                        <div class="span3">
                            <div class="dataset-search-here"></div>
                            <!--img src="http://assets.okfn.org/images/icons/ajaxload-circle.gif" class="loading" /-->
                            <div class="placeholder-search"></div>
                        </div>
                    </div>
                </div>

                <!--footer>
                    <p>
                        This service is run by the <a href="http://okfn.org">Open
                        Knowledge Foundation</a>
                        &ndash;
                        <a href="http://github.com/rgrp/ckan-explorer">Source Code</a>
                    </p>
                    <p>
                        <a href="http://opendefinition.org/okd/" title="Open Data">
                            <img src="http://assets.okfn.org/images/ok_buttons/od_80x15_blue.png" alt="" border="" /></a>
                        <a href="http://opendefinition.org/ossd/" title="Open Online Software Service">
                            <img src="http://assets.okfn.org/images/ok_buttons/os_80x15_orange_grey.png" alt="" border="" />
                        </a>
                    </p>
                </footer-->
            </div>
            <!-- /content -->
        </div>
        <!-- /container -->

        <script type="text/javascript">


    //The code below is derived mainly from here: https://github.com/rgrp/ckan-explorer/master/js/app.js
    //It accesses the main CKAN API (catalogue of Datasets & Resources) here: http://docs.ckan.org/en/latest/api/index.html
    //For Resources persisted to the CKAN Datastore, it accesses the DataStore API here: http://docs.ckan.org/en/latest/maintaining/datastore.html

    // ==============================================================
    // Using recline.js client library - https://github.com/okfn/recline.js
    // ==============================================================

            var ckan = null;

    var DataView = Backbone.View.extend({
        class: 'data-view',
        initialize: function (options) {
            var self = this;
            this.dataset = new recline.Model.Dataset({
                endpoint: options.endpoint,
                id: options.resourceId,
                backend: 'ckan'
            });
            this.dataset.fetch()
                    .done(function () {
                        self.render();
                    });
        },


        render: function () {
            var html = Mustache.render(this.template, {resource: this.dataset.toJSON()});
            this.$el.html(html);

            this.view = this._makeMultiView(this.dataset, this.$el.find('.multiview'));
            this.dataset.query({size: this.dataset.recordCount});
        },

        _makeMultiView: function (dataset, $el) {
            var gridView = {
                id: 'grid',
                label: 'Grid',
                view: new recline.View.SlickGrid({
                    model: dataset,
                    state: {
                        fitColumns: true
                    }
                })
            };
            var graphView = {
                id: 'graph',
                label: 'Graph',
                view: new recline.View.Flot({
                    model: dataset
                })
            };
            var mapView = {
                id: 'map',
                label: 'Map',
                view: new recline.View.Map({
                    model: dataset
                })
            };
            view = new recline.View.MultiView({
                model: dataset,
                views: [gridView, graphView, mapView],
                sidebarViews: [],
                el: $el
            });
            return view;
        },
        events: {
            'submit .query-sql': 'sqlQuery',
            'submit .push-tableau': 'tableauEventHandler'
        },

        template: ' \
    <form class="form query-sql"> \
      <h3>SQL Query</h3> \
      <p class="help-block">Query this table using SQL via the <a href="http://docs.ckan.org/en/latest/maintaining/datastore.html#ckanext.datastore.logic.action.datastore_search_sql">DataStore SQL API</a>.</p> \
      <textarea style="width: 100%;">SELECT * FROM "{{resource.id}}"</textarea> \
      <div class="sql-error alert alert-error" style="display: none;"></div> \
      <button type="submit" class="btn btn-primary">Refresh Query</button> \
    </form> \
    <form class="form push-tableau"> \
      <button type="submit" class="btn btn-primary">Push to Tableau</button> \
    </form> \
    <div class="sql-results"></div> \
    <div class="multiview"></div> \
    ',

        sqlQuery: function (e) {
            var self = this;
            e.preventDefault();

            var $error = this.$el.find('.sql-error');
            $error.hide();
            var sql = this.$el.find('.query-sql textarea').val();
            // replace ';' on end of sql as seems to trigger a json error
            sql = sql.replace(/;$/, '');
            ckan.datastoreSqlQuery(sql, function (err, data) {
                if (err) {
                    var msg = '<p>Error: ' + err.message + '</p>';
                    $error.html(msg);
                    $error.show('slow');
                    return;
                }

                // now handle good case ...
                var dataset = new recline.Model.Dataset({
                    records: data.hits,
                    fields: data.fields
                });
                dataset.fetch();
                //var fieldNames = dataset.fields.pluck('label');
                //var fieldTypes = dataset.fields.pluck('type');
                //console.log(fieldnames);
                //console.log(fieldtypes);
                //dataset.fields.each(function(fieldname){
                //    console.log(fieldname.get('label'));
                //})
                //console.log(dataset.fields.get(label));
                //console.log(dataset.records.toJSON());
                //console.log(dataset.fields.toJSON().label);
                //console.log(dataset.fields.type.toJSON());
                //console.log(dataset.fields._byId.attributes);
                //console.log(dataset.fields._byId.attributes.type);
                //console.log(dataset.records);
                // destroy existing view ...
                var $el = $('<div />');
                $('.sql-results').append($el);
                if (self.sqlResultsView) {
                    self.sqlResultsView.remove();
                }

                self.sqlResultsView = self._makeMultiView(dataset, $el);
                dataset.query({size: dataset.recordCount});
                //console.log(dataset.records.toJSON());
            });
        },
        tableauEventHandler: function (e) {
            var self = this;
            e.preventDefault();

            var $error = this.$el.find('.sql-error');
            $error.hide();
            var sql = this.$el.find('.query-sql textarea').val();
            // replace ';' on end of sql as seems to trigger a json error
            sql = sql.replace(/;$/, '');
            // set the sql statement as the connection data so we can get to it when we fetch the data
            tableau.connectionData = JSON.stringify(sql);
            // name the data source ... ideally this would be something set by the user in a dialogue box ... for now just Test + yyyymmddhhmm
            var currentdate = new Date();
            var datetime = currentdate.getFullYear().toString()
                    + n(currentdate.getMonth() + 1)
                    + n(currentdate.getDate()) + "_"
                    + n(currentdate.getHours()) +
                    + n(currentdate.getMinutes()) +
                    + n(currentdate.getSeconds());
            function n(n){
                return n > 9 ? "" + n: "0" + n;
            }
            tableau.log(datetime);
            tableau.log(tableau.connectionData);
            tableau.connectionName = 'Test_' + datetime;
            tableau.submit();
        },
        // Tableau-related stuff
        getColumnHeaders: function getColumnHeaders() {
            // Tell Tableau about fields and types
            sql = tableau.connectionData;
            ckan.datastoreSqlQuery(sql, function (err, data) {
                if (err) {
                    var msg = '<p>Error: ' + err.message + '</p>';
                    $error.html(msg);
                    $error.show('slow');
                    return;
                }

                // now handle good case ...
                var dataset = new recline.Model.Dataset({
                    records: data.hits,
                    fields: data.fields
                });

                dataset.fetch();
                var fieldNames = dataset.fields.pluck('label');
                var fieldTypes = dataset.fields.pluck('type');
                //console.log(fieldNames);

                tableau.headersCallback(fieldNames, fieldTypes); // tell tableau about the fields and their types
                tableau.log(fieldNames);
                tableau.log(fieldTypes);
            });
        },
        getTableData: function getTableData(lastRecordNumber) {
            if (!tableau) {
                alert("ckan getColumnHeaders- tableau NOT defined!");
                return;
            }
            var sql = tableau.connectionData;
            lastRecordNumber = lastRecordNumber || 0;
            //if (lastRecordNumber == -1) {
            //    tableau.dataCallback([], lastRecordNumber);
            //    return;
            //}
            // Call back to Tableau with table data
            tableau.dataCallback([], lastRecordNumber);

            ckan.datastoreSqlQuery(sql, function (err, data) {
                if (err) {
                    var msg = '<p>Error: ' + err.message + '</p>';
                    $error.html(msg);
                    $error.show('slow');
                    return;
                }

                // now handle good case ...
                var dataset = new recline.Model.Dataset({
                    records: data.hits,
                    fields: data.fields
                });
                dataset.fetch();
                //console.log(dataset.fields);
                //console.log(dataset.records);
                // destroy existing view ...
                var $el = $('<div />');
                $('.sql-results').append($el);
                if (self.sqlResultsView) {
                    self.sqlResultsView.remove();
                }

                self.sqlResultsView = self._makeMultiView(dataset, $el);
                dataset.query({size: dataset.recordCount});
                var rowData = dataset.records.toJSON();
                tableau.dataCallback(rowData, dataset.recordCount);
                tableau.log(rowData);
            });
        }
    });

    var CKANSearchWidget = Backbone.View.extend({
        template: '\
    <div class="data-search"> \
      <form class="form">\
        <input type="search" value="{{q}}" placeholder="Search for data" />\
        <br />\
        <p class="help-block">We\'ll only show datasets where data is in the DataStore</p> \
      </form>\
      <ul class="dataset-list"></ul>\
    </div> \
  ',
        templateDataset: ' \
    <div class="dataset summary"> \
      <h4>{{title}}</h4> \
      {{# resources }}\
      <ul class="resource-list">\
        {{# datastore_active}} \
        <li class="active"> \
          <a href="#" class="js-add-resource" data-id="{{id}}">{{ name }}</a> \
        {{/ datastore_active}} \
        {{^ datastore_active }} \
        <li> \
            <span title="not in DataStore">{{ name }}</span> \
        {{/ datastore_active }} \
        </li> \
      </ul> \
      {{/resources }}\
    <div> \
  ',
        events: {
            'submit form': 'query',
            'click .js-add-resource': '_selectResource'
        },
        initialize: function () {
            var self = this;
            this.collection = new Backbone.Collection();
            _.bindAll(this, 'render');
            this.collection.bind('reset', this.render);
            // first get list of all resources in the datastore
            ckan.action('datastore_search', {resource_id: '_table_metadata', limit: 100000}, function (err, out) {
                self.resourcesInDatastore = _.pluck(out.result.records, 'name');
                self.query();
            });
        },
        render: function () {
            var self = this;
            var html = Mustache.render(this.template, {q: this.currentQuery});
            this.$el.html(html);
            this.collection.each(function (dataset) {
                var html = Mustache.render(self.templateDataset, dataset.toJSON());
                self.$el.find('.dataset-list').append(html);
            });
            return this;
        },
        query: function (e) {
            var self = this;
            if (e) {
                e.preventDefault();
            }
            this.currentQuery = this.$('form input[type="search"]').val();
            ckan.action('dataset_search', {q: this.currentQuery}, function (err, out) {
                _.each(out.result.results, function (dataset) {
                    // should have datastore_active set but unfortunately not ...
                    // see https://raw.github.com/datasets/gold-prices/master/data/data.csv
                    _.each(dataset.resources, function (res) {
                        // make sure it has a name because we use it in the templating ...
                        res.name = res.name || res.description.slice(0, 30) || 'No name';
                        //console.log(res.id);
                        //console.log(self.resourcesInDatastore);
                        if (self.resourcesInDatastore.indexOf(res.id) != -1) {
                            res.datastore_active = true;
                        }
                    });
                });
                self.collection.reset(out.result.results);
            });
        },
        _selectResource: function (e) {
            e.preventDefault();
            var id = $(e.target).data('id');
            this.trigger('resource:select', id);
        }
    });

    jQuery(document).ready(function ($) {
        var $el = $('.dataset-search-here');
        // support for using query string state
        var qs = parseQueryString(location.search);
        var endpoint = qs.endpoint || 'http://demo.ckan.org';
        if (!endpoint.match(/api$/)) {
            endpoint += '/api'
        }
        // defined in global namespace above but set to null
        ckan = new CKAN.Client(endpoint)

        var search = new CKANSearchWidget({
            el: $el
        });

        var $container = $('.data-views-container');
        search.on('resource:select', function (id) {
            $('.intro-div').hide('slow');
            var $el = $('<div class="data-view"></div>');
            $container.append($el);
            var view = new DataView({
                resourceId: id,
                endpoint: endpoint,
                el: $el
            });
        });

        if (qs.resource) {
            search.trigger('resource:select', qs.resource);
        }
    });

    parseQueryString = function (q) {
        if (!q) {
            return {};
        }
        var urlParams = {},
                e, d = function (s) {
                    return decodeURIComponent(s.replace(/\+/g, " "));
                },
                r = /([^&=]+)=?([^&]*)/g;

        if (q && q.length && q[0] === '?') q = q.slice(1);
        while (e = r.exec(q)) {
            // TODO: have values be array as query string allow repetition of keys
            urlParams[d(e[1])] = d(e[2]);
        }
        return urlParams;
    };

    function init() {
        if (!tableau) {
            alert("init- tableau NOT defined!");
            return;
        }
        //tableau.scriptVersion = "1.1";
        tableau.log("init");
        tableau.initCallback();
    }

    function shutdown() {
        tableau.shutdownCallback();
    }

    function getColumnHeaders() {
        DataView.getColumnHeaders();
    }

    function getTableData(lastRecordNumber) {
        DataView.getTableData(lastRecordNumber);
    }

    // These are experimental approaches to accessing the data from the DataStore API.
    // http://docs.ckan.org/en/latest/maintaining/datastore.html

    var ckanSite = 'http://demo.ckan.org'
    var apiKey = '1798247d-73ba-41fa-97fb-4fb6835ebe8f'
    var resource_id = 'f6331f99-51f6-44d9-95b9-b20f3b74f360'
    var sql = 'SELECT * FROM \"f6331f99-51f6-44d9-95b9-b20f3b74f360\" LIMIT 1000';

    // =================
    // Using jQuery only
    // =================

    var data = encodeURIComponent(JSON.stringify({sql: sql}));

    $.ajax({
        url: ckanSite + '/api/3/action/datastore_search_sql',
        type: 'POST',
        dataType: 'json',
        data: data,
        success: function (data) {
            console.log(data)
        }
    });


    // ==============================================================
    // Using ckan.js client library - https://github.com/okfn/ckan.js
    // ==============================================================

    var client = new CKAN.Client(ckanSite, apiKey);
    client.action('datastore_search_sql', {
                sql: sql
            },
            function (err, out) {
                if (err) console.log(err);
                console.log(out);
            });


    client.action('datastore_search', {
                resource_id: resource_id,
                limit: 1000
            },
            function (err, out) {
                if (err) console.log(err);
                console.log(out);
            });

    // This approach is only returning 10 hits ...
    var queryObj = {
        resource_id: resource_id
    };

    client.datastoreQuery(queryObj, function (err, out) {
        // out will follow recline structure, viz
        if (err) console.log(err);
        console.log(out);
    });


    // ==============================================================
    // Using recline.js client library - basic use-case
    // ==============================================================

    var dataset = new recline.Model.Dataset({
        // general metadata e.g.
        id: resource_id,
        // information about data source e.g.
        url: ckanSite,
        // backend string or object
        backend: 'ckan'
    });

    // initialize dataset with data from the backend.
    dataset.fetch().done(function () {
        dataset.query({size: dataset.recordCount});
    });

    //dataset.fetch().done(function(dataset) {
    //    if (console) {
    //        console.log(dataset.records);
    //    }
    //});

        </script>
    </body>
</head>
</html>